# Events

## Overview

An event is something that happens that can affect the system. An event refers to a type of occurrence rather than any concrete instance of that occurrence. For example,  a scan is an event on a container, but each individual scan (GI/Outbound) is not an event but a concrete instance of that occurrence.

An event can have associated parameters, allowing the event instance to convey not only the occurrence of an incidence of interest but also the quantitative information regarding that occurrence. For example, a scan event generated on scanning a barcode has associated parameters that convey the participants involved.

An event instance outlives the instantaneous occurrence that generated the event and might convey this occurrence to one or more state machines. Once generated, the event instance goes through a processing lifecycle that can consist of up to three stages. First the event instance is received when it is accepted and awaits processing (API Invocation, Queues), then the event is dispatched to the state machine, at which point it becomes the current event. Finally it is consumed when the state machine finishes processing the event. A consumed event instance is no longer available for processing.

## Event Attributes

**Name**: Unqiue name of an event
**Models**: Collection of models associated with the event
**Arguments**: Any free text arguments accompanies with an event

## Event Registration

Developers can register an event given the models affected by the vent are pre registered

Registering an event

```javascript
Event.register(eventName, <Model1, Model2>, <args>)
```

Registering an event, would generate stubs for writing execution tasks


```javascript
Event.register("OrderDelivered", M1, M2)
// The above event registeration would generate boilerplate

function OrderDeliveredM1(M1, const M2) {}
function OrderDeliveredM2(const M1, M2) {}

// The above stubs are to be implmented and deployed
```

## Event Generation

An event can be generated by an any external system or execution task and pushed to the event stream.

## Event Flow

An incoming event triggers execution tasks of all the models associated with the event. Detailed description of an event flow: 

- Event class verifies models are of valid type
- Resolver fetches data for all the associated models
- Lifecycle of all models associated with the event are fetched
- Rule engine is queried to get execution tasks of each life cycle based on the event and model data
- Tasks are executed to generated 
- Transaction is generated for the outputs generated by tasks
- Transaction is commited


```javascript
enum DataTypes {
  ...
}

interface Model {
  [key: string]: DataTypes
}

class Event <M extends Model, .... V> {
  readonly models: M[];

  // validate models are of valid Model
  constructor(M....m, V...v) {
    foreach(m_ : m)  {
      assert(typeof(m_ in M));
    }
  }
}


class DelhiveryPromise {
  function process<Event> (Event e) {

    // gets data by hitting db
    data = e.models.reduce((acc, model) => {
      acc.append(resolve(model));
    }, []}

    // get reference to the lifecycle of models
    lifecycles = e.model.reduce((acc, model) => {
      acc.append(getLifeCycleFunction(typeof model));

      return acc;
    }, []);

    // get tasks of a particular lifecycle
    handlers = lifecycles.reduce((acc, lifecycle) => {
      handler = lifecycle.evaluate(type of e, data);
      acc.append(handler)

      return acc;
    }, []);


    // execute tasks
    changes = handlers.reduce((acc, handler) => {
      output = handler.execute(data);
      acc.push.back(output);

      return acc;
    });

    // create transactions
    transaction = changes.reduce((acc, handler) => {
      acc.append({
        oldValue: change.oldValue,
        newValue: change.newValue,
      });

      return acc;
    });

    // do commit
    db.commit(transactions)
  }
}

```
