# Event Implementation Spec


## Event Flow

An incoming event triggers execution tasks of all the models associated with the event. Detailed description of an event flow: 

- Event class verifies models are of valid type
- Resolver fetches data for all the associated models
- Lifecycle of all models associated with the event are fetched
- Rule engine is queried to get execution tasks of each life cycle based on the event and model data
- Tasks are executed to generated 
- Transaction is generated for the outputs generated by tasks
- Transaction is commited


```javascript
enum DataTypes {
  ...
}

interface Model {
  [key: string]: DataTypes
}

class Event <M extends Model, .... V> {
  readonly models: M[];

  // validate models are of valid Model
  constructor(M....m, V...v) {
    foreach(m_ : m)  {
      assert(typeof(m_ in M));
    }
  }
}


class DelhiveryPromise {
  function process<Event> (Event e) {

    // gets data by hitting db
    data = e.models.reduce((acc, model) => {
      acc.append(resolve(model));
    }, []}

    // get reference to the lifecycle of models
    lifecycles = e.model.reduce((acc, model) => {
      acc.append(getLifeCycleFunction(typeof model));

      return acc;
    }, []);

    // get tasks of a particular lifecycle
    handlers = lifecycles.reduce((acc, lifecycle) => {
      handler = lifecycle.evaluate(type of e, data);
      acc.append(handler)

      return acc;
    }, []);


    // execute tasks
    changes = handlers.reduce((acc, handler) => {
      output = handler.execute(data);
      acc.push.back(output);

      return acc;
    });

    // create transactions
    transaction = changes.reduce((acc, handler) => {
      acc.append({
        oldValue: change.oldValue,
        newValue: change.newValue,
      });

      return acc;
    });

    // do commit
    db.commit(transactions)
  }
}

```



## Event Registration

Developers can register an event given the models affected by the vent are pre registered

**Event Attributes**

- **Name**: Unqiue name of an event
- **Models**: Collection of models associated with the event
- **Arguments**: Any free text arguments accompanies with an event

**Registering an event**

```javascript
Event.register(eventName, {Model1, Model2}, args);

//example
Event.register("OrderDelivered", M1, M2, args)
```

**Register Event Callback**
After registering an event, an event callback can be declared. The library will return boilerplate functions to implement on successful registration of an event callback.

```javascript
Event.registerCallback(eventName)

//returns
eventFunctions = [
  function eventNameForM1(M1, const M2....) {}, // execution task
  function eventNameForM2(const M1, M2.....) {} // execution task
]
```

**Deploy event callback method**

Once the devs have implemented the execution task, they can be deployed

```javascript
eventFunctions.deploy()
```

## Event Generation

An event can be generated by any external system or execution task and pushed to the event stream.

```javascript
Event event = new Event();
event.setEventName("orderDelivered");
event.setModels(m1 typeof M1);
event.setModels(m2 typeof M1);
event.push();
```