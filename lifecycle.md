# Lifecycle

## Overview

The lifecycle of any object can be thought of as a state machine such that each entity or each of its sub-entities is exactly always in one of a possible number of states and where there are well-defined conditional transitions between these states.

Business/Product can declare the lifecycle of each model in the system and events associated with each state of the lifecycle. The events may cause change in state of a model's lifecycle

## Technical Definition

A lifecycle is a suquence of events associated with a model that governs the actions available (or to be performed) on instances of the model. Additionally, lifecycles can be chained to create larger lifecycles.



```ts
// DSL for lifecycle
{
  "name": "string",
  "start": "<event_drn>",
  "<event_drn>": {
    "callback": "<callback_drn>",
    "next": [
      "<event_drn>",
      "<lifecycle_drn>",
    ],
    "emit": [
      "<event_drn>",
    ]
  },
}

// Constraints on events
for(const eventDefinition: lifecycle.events) {
  nextEvents = [event_drn for event in eventDefinition.next] + [lifecycle.start for lifecycle in eventDefinition.next];

  if (nextEvents.length() != set(nextEvents).length) {
    throw Error("Invalid event definition. Multiple executions for event found in chain");
  }
}
```

### Execution

Lifecycle is executed when an event is generated. An event can be generated by integration endpoints (HTTP Api, Message Qeueues, RPC). Lifecycles are themselves executed as an event loop which is governed by the definition above.

An event causes the evaluation of lifecycle to validate if the said event is acceptable at the current state of the lifecycle or not. And if the event is acceptable, lifecycle will determine which function to invoke based on it's internal state

An event can be valid for multiple states of a lifecycle. For example:
'cancelOrder' event will have to be attached to all states of a lifecycle if cancellation if to be allowed at all times during the lifecycle of an order.

#### Example

```
         (onAccept)            (onAssign)           (onPick)            (onDeliver)
Created -----------> Accepted -----------> Assigned ---------> Picked -------------> Delivered
  |                    |                      |                 |
  |                    |                      |                 |
  |  (onCancel)        | (onCancel)           | (onCancel)      | (onCancel)
  v                    |                      |                 |
Cancelled <------------  <--------------------   <-------------- 

```

# Capabilities

## Definition

Capabilities are boolean expression evaluated dynamically based on the value of extended state variables and event parameters. Capabilities affect the behavior of a lifecycle by enabling transitions only when they evaluate to TRUE and disabling them when they evaluate to FALSE.

If a capability has no expression or expression evaluation fails then it will evaluate to true.



```ts
interface Capability {
  name: String;
  expression?: String; // valid JSONpath expression
}
```

#### Example

Secured package capability which will evaluate whether to enable OTP verification lifeycle or not
```json
{
  "name": "verifyOTP",
  "expression": "$.pkg.type == 'BFSI'",
}
```

```
  (onVerify)                                                                          (onDelivery)
 ------------>[verifyOTP]->| initiateVerification -> matchOTP -> recordVerifcation | --------------> Delivered 
```



